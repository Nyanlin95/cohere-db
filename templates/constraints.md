# Query Constraints & Limits

> AUTO-GENERATED by cohere. Core limits apply to all agents.

## Universal Query Limits

| Operation | Limit | Reason |
|-----------|-------|--------|
| SELECT rows (unlimited) | 10,000 max | Prevent context exhaustion |
| SELECT with OFFSET | 1,000 max | Performance degradation |
| JOIN depth | 5 max | Query complexity |
| Subquery nesting | 3 max | Performance |
| INSERT rows (batch) | 1,000 max | Transaction size |
| DELETE rows (batch) | 1,000 max | Lock duration |
| Query timeout | 30s | Resource sharing |

## Required Patterns (All Agents)

### LIMIT Required
```sql
-- ✓ CORRECT: Always use LIMIT
SELECT * FROM orders 
WHERE organization_id = $1 
ORDER BY created_at DESC 
LIMIT 100;

-- ✗ WRONG: No LIMIT on potential large tables
SELECT * FROM orders;
```

### ORDER BY Required
```sql
-- ✓ CORRECT: ORDER BY for deterministic results
SELECT * FROM users 
WHERE organization_id = $1 
ORDER BY created_at DESC 
LIMIT 50;

-- ✗ WRONG: No ORDER BY (results may vary)
SELECT * FROM users LIMIT 50;
```

### Soft Delete Filter
```sql
-- ✓ CORRECT: Always exclude soft-deleted
SELECT * FROM orders 
WHERE deleted_at IS NULL 
AND organization_id = $1;

-- ✗ WRONG: May include deleted records
SELECT * FROM orders;
```

---

## Multi-Tenant Constraints

### Organization Isolation Required
```sql
-- ✓ CORRECT: Organization check included
SELECT * FROM users 
WHERE id = $1 
AND organization_id = $2;

-- ✗ WRONG: Missing organization_id (security risk!)
SELECT * FROM users WHERE id = $1;
```

> [!NOTE|CLAUDE]
> Claude Code: Automatically enforces organization_id when `CLAUDE.md` includes tenant rules.

> [!NOTE|CODEX]
> **CODEX REQUIREMENT**: You must explicitly state tenant isolation rules in AGENTS.md:
> ```
> All database queries MUST include organization_id filter.
> Tables without organization_id are single-tenant.
> ```
> Codex will NOT infer this without explicit instructions.

> [!NOTE|ANTIGRAVITY]
> Antigravity MCP: Use `tenant_id` or `organization_id` consistently. Parallel agents must share isolation context.

---

## Pagination Patterns

### Keyset Pagination (Universal)
```typescript
// More efficient than OFFSET for large datasets
async function getNextPage(
  lastId: string, 
  limit: number = 50
): Promise<Data[]> {
  return query(`
    SELECT * FROM items 
    WHERE id > $1 
    AND organization_id = $2
    ORDER BY id 
    LIMIT $3
  `, [lastId, orgId, limit]);
}
```

### Offset Pagination (Simple Cases)
```sql
-- Acceptable for small offsets
SELECT * FROM items 
WHERE organization_id = $1 
ORDER BY created_at DESC 
LIMIT 50 OFFSET 100;
```

> [!NOTE|CLAUDE]
> Claude: Keyset pagination is preferred for large datasets. Built-in optimization.

> [!NOTE|XCODE]
> Xcode 26.3: For Swift playgrounds, use cursor-based pagination matching Swift idioms.

---

## Large Table Handling

### For Tables > 1M Rows
```sql
-- Use approximate counts
SELECT reltuples::bigint AS approximate_count
FROM pg_class 
WHERE relname = 'large_table';

-- Sample-based queries
SELECT * FROM large_table TABLESAMPLE SYSTEM (1)
WHERE organization_id = $1;
```

### For Bulk Operations
```sql
-- Batch into chunks of 1000
INSERT INTO target_table (col1, col2)
SELECT col1, col2 FROM source_table
WHERE created_at < $1
LIMIT 1000;

-- Repeat until complete, tracking progress
```

---

## Memory Budget (Context Limits)

| Operation | Est. Tokens | Action if Exceeded |
|-----------|-------------|-------------------|
| Schema dump | ~2,000 | Skip comments, compress |
| Full table list | ~500 | Limit to active tables |
| Query result | ~1,000 | Apply LIMIT, paginate |
| Relationship graph | ~800 | Simplify, hide rarely-used |

> [!NOTE|CODEX]
> **CODEX TOKEN WARNING**: Codex has strict token limits. Keep AGENTS.md under 4000 tokens total.
> - Put essential patterns only
> - Link to full docs, don't inline
> - Use compression: `tables: users, orders, products`

> [!NOTE|ANTIGRAVITY]
> Antigravity: Parallel agents share context budget. Coordinate via `.ai/memory/checkpoints/`.

---

## Context Guardrails

### Universal Validator
```typescript
function validateQueryBounds(sql: string): void {
  const lower = sql.toLowerCase();
  
  // Check LIMIT
  if (!lower.includes('limit')) {
    throw new Error('Query requires LIMIT clause');
  }
  
  // Check forbidden patterns
  const forbidden = [
    /select\s+\*/i,           // Should specify columns
    /without\s+limit/i,       // Needs explicit limit
  ];
  
  for (const pattern of forbidden) {
    if (pattern.test(sql)) {
      console.warn(`Query pattern "${pattern}" detected - review recommended`);
    }
  }
}
```

---

## Emergency Procedures

### Context Overflow
1. Stop non-critical queries
2. Save current state to checkpoint (`.ai/memory/checkpoints/`)
3. Restart with minimal context
4. Resume from checkpoint

### Query Timeout
1. Check if index exists
2. Add `EXPLAIN ANALYZE` prefix
3. Optimize or chunk the query

---

## Agent-Specific Context Paths

| Agent | Context File | Auto-load? |
|-------|-------------|------------|
| Claude | `.ai/CLAUDE.md` | ✓ Yes |
| Claude | `~/.Claude/CLAUDE.md` | ✓ Yes (user-level) |
| Codex | `.ai/AGENTS.md` | ✗ **NO** - must prompt |
| Antigravity | `.ai/AGENTS.md` | Depends on MCP |
| Xcode | `.ai/CLAUDE.md` | Via extension |

---
*Last updated: 2026-02-08*
