# Edge Case Test Templates

> AUTO-GENERATED by cohere. Copy to `.ai/test-templates/` and customize.

---

## Universal Test Patterns

These tests work across all agents (Claude, Codex, Antigravity, Xcode).

### Empty Result Set
```typescript
test('SELECT returns empty array when no rows match', async () => {
  const result = await query(
    'SELECT * FROM users WHERE email = $1',
    ['nonexistent@example.com']
  );
  expect(result).toEqual([]);
});
```

### Soft Delete Handling
```typescript
test('SELECT excludes soft-deleted records by default', async () => {
  const result = await query(
    'SELECT * FROM orders WHERE organization_id = $1',
    [orgId]
  );
  expect(result.rows.every(r => r.deleted_at === null)).toBe(true);
});
```

---

> [!NOTE|CLAUDE]
> Claude Code: Tests run via `npm test`. Use `claude test` for agent-specific testing.

> [!NOTE|CODEX]
> **CODEX SPECIFIC**: Codex requires explicit test file inclusion:
> ```
> I have edge case tests in .ai/test-templates/. Run them to verify.
> ```
> Tests won't run unless explicitly invoked.

> [!NOTE|ANTIGRAVITY]
> Antigravity: Parallel agents should run tests independently, share results via `.ai/memory/test-results/`.

> [!NOTE|XCODE]
> Xcode: Tests go in `Tests/` directory. Use XCTest framework.

---

## 1. CRUD Edge Cases

### Empty Result Set
```typescript
test('SELECT returns empty array when no rows match', async () => {
  const result = await query(
    'SELECT * FROM users WHERE email = $1',
    ['nonexistent@example.com']
  );
  expect(result).toEqual([]);
});
```

### Single Row Edge Cases
```typescript
test('INSERT fails on duplicate primary key', async () => {
  await expect(query(
    'INSERT INTO users (id, email) VALUES ($1, $2)',
    [existingId, 'new@example.com']
  )).rejects.toThrow('duplicate_key');
});

test('UPDATE modifies correct row with unique constraint', async () => {
  const result = await query(
    'UPDATE users SET email = $1 WHERE id = $2',
    ['updated@example.com', targetId]
  );
  expect(result.rowCount).toBe(1);
});
```

---

## 2. Foreign Key Edge Cases

### Orphaned Records
```typescript
test('SELECT with JOIN skips orphaned foreign keys', async () => {
  const result = await query(`
    SELECT o.*, u.email 
    FROM orders o
    JOIN users u ON o.user_id = u.id
    WHERE o.organization_id = $1
  `, [orgId]);
  // Only returns orders with valid user_id
  expect(result.rows.every(r => r.user_id !== null)).toBe(true);
});
```

### Cascade Delete
```typescript
test('Parent deletion cascades to children', async () => {
  await query('DELETE FROM users WHERE id = $1', [parentId]);
  
  const childResult = await query(
    'SELECT * FROM orders WHERE user_id = $1',
    [parentId]
  );
  expect(childResult.rows.length).toBe(0);
});
```

---

## 3. Concurrency Edge Cases

### Race Conditions
```typescript
test('Concurrent INSERTs with unique constraint', async () => {
  const concurrentInserts = Array(5).fill(null).map(() =>
    query(
      'INSERT INTO unique_values (name) VALUES ($1) ON CONFLICT DO NOTHING',
      ['unique_name']
    )
  );
  
  const results = await Promise.all(concurrentInserts);
  const successfulInserts = results.filter(r => r.rowCount === 1);
  
  // Only one should succeed
  expect(successfulInserts.length).toBe(1);
});
```

> [!NOTE|ANTIGRAVITY]
> **IMPORTANT**: Parallel agents must use transaction isolation. Test with:
> ```sql
> BEGIN ISOLATION LEVEL SERIALIZABLE;
> -- operations
> COMMIT;
> ```

---

## 4. Data Type Edge Cases

### NULL Handling
```typescript
test('NULL comparison in WHERE clause', async () => {
  const result = await query(
    'SELECT * FROM users WHERE email IS NULL',
    []
  );
  expect(result.rows.every(r => r.email === null)).toBe(true);
});

test('NULL in NOT IN with empty subquery', async () => {
  const result = await query(
    'SELECT * FROM users WHERE id NOT IN (SELECT user_id FROM inactive_logins)',
    []
  );
  // Should return all users, not filtered by NULL subquery
  expect(result.rows.length).toBeGreaterThan(0);
});
```

---

## 5. Large Dataset Edge Cases

### Pagination Boundaries
```typescript
test('First page returns correct results', async () => {
  const result = await query(`
    SELECT * FROM orders 
    WHERE organization_id = $1
    ORDER BY created_at DESC 
    LIMIT 50 OFFSET 0
  `, [orgId]);
  expect(result.rows.length).toBeLessThanOrEqual(50);
});

test('Last page handles partial results', async () => {
  const result = await query(`
    SELECT * FROM orders 
    WHERE organization_id = $1
    ORDER BY created_at DESC 
    LIMIT 50 OFFSET 950
  `, [orgId]);
  expect(result.rows.length).toBeLessThanOrEqual(50);
});
```

---

## 6. Duplicate Detection Tests

### Primary Key Duplicates
```typescript
test('Detects exact duplicate records', async () => {
  const duplicates = await query(`
    SELECT email, COUNT(*) as cnt
    FROM users
    WHERE deleted_at IS NULL
    GROUP BY email
    HAVING COUNT(*) > 1
  `, []);
  expect(duplicates.rows.length).toBe(0);
});
```

---

## Running Tests (Universal)

```bash
# All agents: Standard command
npm test -- --testPathPattern=test-templates

# Claude-specific
claude test run

# Codex-specific (must be explicit)
codex exec "npm test -- --testPathPattern=test-templates"
```

---
*Template version: 1.0.0*
